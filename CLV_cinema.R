library(BTYD)

library(survival)
library(RODBC)
library(lubridate)
library(dplyr)
library(doParallel)
library(RSQLite)
library(sqldf)
library(data.table)
library(dplyr)
library(h2o)
library(quantmod)
library(lubridate)
library(stringr)
library(purrr)
library(tidyr)
library(tibble)

conn<-odbcConnect("PostgreSQL30")

elog<-sqlQuery(conn, "select cast(cast(cust_sa1 as bigint)/100 as int) sa2, 
                customer_id, tran_date_time, 
                sum(weighted_tran_amount) tran_amount
                from base_westpac.transaction_data
                where tran_month between '2017-11-01' and '2018-04-01' and merchant_category_code=7832 and cust_state=1
                group by 1,2,3")

elog<-elog[which(!is.na(elog$sa2)),]

# elog_sub<-elog %>% filter(sa2 %in% c(117031337, 117031333, 118011343, 118011346, 
#                                      118011340, 118011339, 118011341, 118021348, 
#                                      118011345, 117031336, 117031334,  117031331, 
#                                      117031332, 120031390, 120031575, 121041416,
#                                      121041415, 121011400, 117031330, 117031338))

# elog_sub<-elog %>% filter(sa2 %in% c(206011105,206011106,206011107,206011108,206011109,206021110,206021111,206021112,206031113,206031114,206031115,206031116,206041117,206041118,206041119,206041120,206041121,206041122,206041123,206041124,206041125,206041126,206041127,206051128,206051129,206051130,206051131,206051132,206051133,206051134,206061135,206061136,206061137,206061138,206071139,206071140,206071141,206071142,206071143,206071144,206071145,207011146,207011147,207011148,207011149,207011150,207011151,207011152,207011153,207011154,207011155,207021156,207021157,207021159,207021160,207021424,207021425,207031161,207031162,207031163,207031164,207031165,207031166,207031167,208011168,208011169,208011170,208011171,208011172,208011173,208021174,208021176,208021177,208021178,208021179,208021180,208021181,208021182,208021426,208021427,208031183,208031184,208031185,208031186,208031187,208031188,208031189,208031190,208031191,208031192,208031193,208041194,208041195,209011196,209011197,209011198,209011199,209011200,209011201,209011202,209011203,209011204,209021205,209021207,209021208,209021428,209021429,209031209,209031210,209031211,209031212,209031213,209031214,209031215,209041216,209041217,209041219,209041220,209041221,209041223,209041224,209041225,209041430,209041431,209041432,209041433,209041434,209041435,209041436,209041437,210011226,210011227,210011228,210011229,210011230,210011231,210021232,210021233,210021234,210021235,210031236,210031237,210031239,210031438,210031439,210031440,210041240,210041241,210051242,210051243,210051245,210051246,210051247,210051248,210051249,210051250,210051441,210051442,210051443,210051444,210051445,211011251,211011254,211011255,211011256,211011257,211011258,211011259,211011260,211011446,211011447,211011448,211011449,211021261,211021262,211031263,211031265,211031266,211031267,211031268,211031450,211031451,211031452,211041269,211041270,211041271,211041272,211041273,211051274,211051275,211051276,211051277,211051278,211051279,211051280,211051281,211051282,211051283,211051284,211051285,211051286,212011287,212011288,212011289,212011290,212011291,212011292,212021293,212021294,212021295,212021297,212021299,212021453,212021454,212021455,212021456,212031300,212031301,212031302,212031303,212031304,212031305,212031306,212031308,212031457,212031458,212041309,212041310,212041311,212041312,212041313,212041314,212041316,212041317,212041318,212041459,212041460,212051319,212051320,212051321,212051322,212051323,212051324,212051325,212051326,212051327,213011328,213011329,213011330,213011331,213011332,213011333,213011334,213011335,213011336,213011337,213011338,213011339,213011340,213021341,213021342,213021343,213021344,213021345,213021346,213031347,213031348,213031349,213031350,213031351,213031352,213041353,213041355,213041356,213041357,213041358,213041359,213041360,213041461,213041462,213041463,213051361,213051362,213051363,213051365,213051366,213051368,213051369,213051464,213051465,213051466,213051467,213051468,214011370,214011371,214011372,214011373,214011374,214011375,214011376,214021377,214021378,214021379,214021380,214021381,214021382,214021383,214021384,214021385
# ))

elog_sub<-elog %>% filter(sa2 %in% c(102011028,102011029,102011030,102011031,102011032,102011033,102011034,102011035,102011036,102011037,102011038,102011039,102011040,102011041,102011042,102011043,102021044,102021045,102021046,102021047,102021048,102021049,102021050,102021051,102021052,102021053,102021054,102021055,102021056,102021057,115011290,115011291,115011294,115011296,115011553,115011554,115011555,115011556,115011557,115011558,115011559,115021297,115021298,115031299,115031300,115041301,115041302,116011303,116011304,116011306,116011307,116011308,116011560,116011561,116021309,116021310,116021312,116021562,116021563,116031313,116031314,116031315,116031316,116031317,116031318,116031319,117011320,117011321,117011322,117011323,117011324,117011325,117021326,117021327,117021328,117031329,117031330,117031331,117031332,117031333,117031334,117031335,117031336,117031337,117031338,118011339,118011340,118011341,118011342,118011343,118011344,118011345,118011346,118011347,118021348,118021350,118021564,118021565,118021566,118021567,118021568,118021569,118021570,119011354,119011355,119011356,119011357,119011358,119011359,119011360,119011361,119011571,119011572,119021362,119021363,119021364,119021366,119021367,119021573,119021574,119031368,119031369,119031370,119031371,119031372,119031373,119031374,119041375,119041376,119041377,119041378,119041379,119041380,119041381,119041382,120011383,120011384,120011385,120011386,120021387,120021388,120021389,120031390,120031391,120031392,120031393,120031394,120031395,120031396,120031575,120031576,121011398,121011399,121011400,121011401,121011402,121021403,121021404,121021406,121021577,121021578,121021579,121031407,121031408,121031409,121031410,121031411,121031412,121041413,121041414,121041415,121041416,121041417,122011418,122011419,122021420,122021421,122021422,122021423,122031424,122031425,122031426,122031427,122031428,122031429,122031430,122031431,122031432,123011433,123011434,123011435,123021436,123021437,123021438,123021439,123021440,123021441,123021442,123021443,123021444,123031445,123031446,123031447,123031448,124011449,124011450,124011451,124011452,124011453,124011454,124011455,124021456,124031457,124031458,124031459,124031460,124031461,124031462,124031463,124031464,124031465,124041466,124041467,124041468,124051469,124051470,124051580,124051581,125011473,125011475,125011582,125011583,125011584,125011585,125011586,125011587,125021476,125021477,125021478,125031479,125031480,125031481,125031482,125031483,125031484,125031485,125031486,125031487,125041489,125041490,125041491,125041492,125041493,125041494,125041588,125041589,126011495,126011496,126021497,126021498,126021499,126021500,126021501,126021503,126021590,126021591,127011504,127011505,127011506,127011592,127011593,127011594,127011595,127011596,127011597,127021509,127021510,127021511,127021512,127021513,127021514,127021515,127021516,127021517,127021518,127021519,127021520,127021521,127031522,127031523,127031524,127031598,127031599,127031600,127031601,128011529,128011530,128011531,128011602,128011603,128011604,128011605,128011606,128021533,128021534,128021535,128021536,128021537,128021538,128021607,128021608,128021609
))

elog_sub<-elog_sub[,-c(1)]

elog_sub$tran_date_time<-as.Date(elog_sub$tran_date_time)

names(elog_sub)<-c("cust", "date", "sales")

elog_sub<-dc.MergeTransactionsOnSameDate(elog_sub)

min_date<-min(elog_sub$date)

max_date<-max(elog_sub$date)


end.of.cal.period<-as_date(min_date + as.duration((max_date-min_date)/2))

T.start<-as.numeric(max_date-end.of.cal.period)

T.tot<-end.of.cal.period

n.periods.final<-round(as.numeric(max_date-min_date)/7)

data<-dc.ElogToCbsCbt(elog_sub, per="week", T.cal = end.of.cal.period, statistic = "freq")

cal.cbs<-data[["cal"]][["cbs"]]

params<-pnbd.EstimateParameters(cal.cbs)

pnbd.PlotFrequencyInCalibration(params, cal.cbs, 10)

# pnbd.PlotTrackingInc(params, T.cal, n.periods.final, w.track.data)


elog_1<-dc.SplitUpElogForRepeatTrans(elog_sub)$repeat.trans.elog

tot.cbt<-dc.CreateFreqCBT(elog_1)

cal.cbs_1<-cal.cbs %>% as_tibble(rownames='cust') %>% 
  mutate(x.star=map_int(cust, ~sum(.==elog_1$cust ))-x)

T.cal<-unlist(cal.cbs_1[,"T.cal"], use.names = FALSE)

names(T.cal)<-cal.cbs_1$cust

x.star<-cal.cbs_1$x.star

names(x.star)<-cal.cbs_1$cust

all_dates<-tibble(date=seq(min_date, max_date,1))

d.track.data<-tot.cbt %>% as_tibble() %>% mutate(date=as_date(date)) %>%
  right_join(all_dates, by="date") %>%
  replace_na(replace=list(cust=0,n=0)) %>% 
  group_by(date) %>% summarise(total_purchases=sum(n))

w.track.data<-d.track.data %>% mutate(week=as.numeric(date-min_date) %/% 7) %>%
  filter(week<n.periods.final) %>%
  group_by(week) %>% 
  summarise(by_week_total=sum(total_purchases)) %>%
  pull(by_week_total)

cum.track.data<-cumsum(w.track.data)

pnbd.PlotTrackingCum(params, T.cal, n.periods.final, cum.track.data, n.periods.final)

pnbd.PlotTrackingInc(params, T.cal, n.periods.final, w.track.data, n.periods.final)

heatmap.palive.data<-matrix(NA, nrow = 30, ncol=30)

heatmap.cet.data<-matrix(NA, nrow=30, ncol=30)

for (i in 1:30){
  heatmap.cet.data[i,]<-pnbd.ConditionalExpectedTransactions(params, T.star = 32,x=i,t.x = 1:30, T.cal = 13)
  
  heatmap.palive.data[i,]<-pnbd.PAlive(params, x=i, t.x=1:30, T.cal = 13)
}

image(heatmap.palive.data, axes=FALSE, xlab="Number of Transactions", 
      ylab="Weeks since last transaction", main="P(Alive) by Recency and Frequency")
axis(1, at=seq(0,1,.1), labels=seq(0,30,3))
axis(2, at=seq(0,1,.1), labels=seq(30,0,-3))

image(heatmap.cet.data, axes=FALSE, xlab="Number of Transactions", 
      ylab="Weeks since last transaction", main="Conditional Expected Transactions by Recency and Frequency")
axis(1, at=seq(0,1,.1), labels=seq(0,30,3))
axis(2, at=seq(0,1,.1), labels=seq(30,0,-3))


exp_transactions<-pnbd.Expectation(params, t=52)

purchases<-as_tibble(x.star) %>% 
  rownames_to_column() %>%
  select(cust=rowname, purchases=value)%>%
  arrange(desc(purchases))


mape<-function(actual, predicted){
  n<-length(actual)
  (1/n) * sum(abs((actual-predicted)/actual))
}

expected.cum.trasn<-pnbd.ExpectedCumulativeTransactions(params, T.cal, n.periods.final, n.periods.final)

end.of.cal.week<-round(as.numeric((end.of.cal.period - min(elog_1$date))/7))

total.mape<-mape(cum.track.data,expected.cum.trasn)

in.sample.mape<-mape(cum.track.data[1:end.of.cal.week], expected.cum.trasn[1:end.of.cal.week])

out.of.sample.mape<-mape(cum.track.data[end.of.cal.week:26], expected.cum.trasn[end.of.cal.week:26])




cal.cbt<-dc.ElogToCbsCbt(elog_sub, per="day", T.cal=end.of.cal.period, statistic = "total.spend")

cal.cbs_spend<-cal.cbt$cal$cbs

cal.cbt_spend<-cal.cbt$cal$cbt

calculateAvgSpend<-function(cbt.row){
  purchaseCols<-which(cbt.row!=0)
  sum(cbt.row[purchaseCols])/length(purchaseCols)
}

m.x<-apply(cal.cbt_spend, 1, calculateAvgSpend)

m.x[which(is.na(m.x))]<-0

spendParams<-spend.EstimateParameters(m.x, cal.cbs_spend[,1])

expected.spend<-spend.plot.average.transaction.value(spendParams, m.x, cal.cbs_spend[,1],
                                                     title="Actual vs. Expected Avg Transaction Value Across Customers")


end.of.cal.period.day<-as.Date(end.of.cal.period)

data_day<-dc.ElogToCbsCbt(elog_sub, per="day", T.cal = end.of.cal.period.day)

cal.cbs.day<-data_day[["cal"]][["cbs"]]

params<-pnbd.EstimateParameters(cal.cbs.day)

x<-cal.cbs.day[,"x"]

t.x<-cal.cbs.day[,"t.x"]

T.cal<-cal.cbs.day[,"T.cal"]

# Discount Rate
d<-0.15

dis_exp_transactions<-pnbd.DERT(params, x, t.x, T.cal, d/52)

expected_spend<-spend.expected.value(spendParams, m.x, cal.cbs.day[,1])

projected_future_revenue<-expected_spend * dis_exp_transactions


output<-data.frame(cust=data_day$cust.data$cust, dis_exp_transactions=dis_exp_transactions,
                   expected_spend=expected_spend, projected_future_revenue=projected_future_revenue)


elog_full<-unique(merge(elog[, 1:2], output, by.x="customer_id", by.y = "cust"))

CLV_by_SA2<-elog_full %>% group_by(sa2) %>% summarise(avg_CLV=mean(projected_future_revenue))
         
# CLV_by_SA2_20<-CLV_by_SA2 %>% filter(sa2 %in% c(2060111,2060211, 2060311, 2060411, 2060511,2060611, 2060711, 2070111,2070112, 2070212, 2070214, 2070312, 2080112, 2080212,
#                                                 2080214, 2080312, 2080412))

# write.csv(CLV_by_SA2, "C:/dev/KZ/CLV_by_SA2_Central_Sydney.csv", row.names=FALSE)































 
